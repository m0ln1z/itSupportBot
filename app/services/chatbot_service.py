from openai import OpenAI
import asyncio
from typing import Dict, List
import re
from datetime import datetime

from app.config import settings

class ChatbotService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ò–ò —á–∞—Ç-–±–æ—Ç–æ–º"""
    
    def __init__(self):
        self.client = OpenAI(api_key=settings.OPENAI_API_KEY) if settings.OPENAI_API_KEY else None
        self.knowledge_base = self._load_knowledge_base()
    
    def _load_knowledge_base(self) -> Dict[str, str]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤"""
        return {
            "password": """
–î–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è:
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É https://password-reset.company.com
2. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ä–∞–±–æ—á–∏–π email
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º
4. –ï—Å–ª–∏ –ø–∏—Å—å–º–æ –Ω–µ –ø—Ä–∏—à–ª–æ, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É "–°–ø–∞–º"
5. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∞—Ä–æ–ª—é:
- –ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤
- –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–ª–∞–≤–Ω—ã–µ –∏ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã
- –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ü–∏—Ñ—Ä—ã
- –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
            """,
            
            "access": """
–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ:
1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –Ω—É–∂–Ω–æ–π –ø–∞–ø–∫–µ
2. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤–∞—à–µ–º—É —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–∞
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É —á–µ—Ä–µ–∑ ServiceDesk —Å —É–∫–∞–∑–∞–Ω–∏–µ–º:
   - –ü–æ–ª–Ω–æ–≥–æ –ø—É—Ç–∏ –∫ –ø–∞–ø–∫–µ
   - –¢–∏–ø–∞ –¥–æ—Å—Ç—É–ø–∞ (—á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å)
   - –ë–∏–∑–Ω–µ—Å-–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è
4. –û–∂–∏–¥–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏ (–æ–±—ã—á–Ω–æ 1-2 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è)
            """,
            
            "documents": """
–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç –≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (PDF, DOC, DOCX)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 10 –ú–ë)
4. –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∏ —Ç–µ–º—É
5. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏

–ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
            """,
            
            "connection": """
–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–±–µ–ª—å Ethernet –∏–ª–∏ Wi-Fi —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
2. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–µ—Ç–µ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
5. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –¥—Ä—É–≥–æ–π —Å–µ—Ç–∏

–î–ª—è VPN –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π VPN –∫–ª–∏–µ–Ω—Ç
- –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–µ—Ç–µ–≤–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
            """,
            
            "software": """
–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –ü–û –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ
2. –ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É —á–µ—Ä–µ–∑ ServiceDesk
3. –£–∫–∞–∂–∏—Ç–µ –±–∏–∑–Ω–µ—Å-–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
4. –î–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è –æ—Ç –ò–¢-—Å–ª—É–∂–±—ã
5. –ü–û –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É–¥–∞–ª–µ–Ω–Ω–æ –∏–ª–∏ –≤–∞–º –±—É–¥—É—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ü–û –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
            """
        }
    
    async def get_response(self, message: str, user_id: str = "anonymous") -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò"""
        try:
            # –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            category = self.classify_message(message)
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            if category in self.knowledge_base:
                base_answer = self.knowledge_base[category]
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ò–ò –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
                system_prompt = f"""
–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –ò–¢-–ø–æ–¥–¥–µ—Ä–∂–∫–∏. –£ —Ç–µ–±—è –µ—Å—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, 
–Ω–æ —Ç—ã –¥–æ–ª–∂–µ–Ω –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å, —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º.

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç: {base_answer}

–û—Ç–≤–µ—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å –≤–µ–∂–ª–∏–≤—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º.
"""
            else:
                system_prompt = """
–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ò–¢-–ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤ —Ä–æ—Å—Å–∏–π—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Ä–µ—à–∏—Ç—å –∏—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã.

–û—Ç–≤–µ—á–∞–π:
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ö—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É
- –° –ø–æ—à–∞–≥–æ–≤—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –∫–æ–≥–¥–∞ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ

–ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É, –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –ò–¢-–ø–æ–¥–¥–µ—Ä–∂–∫–∏.
"""
            
            if not self.client:
                return self._get_fallback_response(message)
                
            response = self.client.chat.completions.create(
                model=settings.OPENAI_MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": message}
                ],
                max_tokens=500,
                temperature=0.7
            )
            
            return response.choices[0].message.content.strip()
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI: {e}")
            return self._get_fallback_response(message)
    
    def classify_message(self, message: str) -> str:
        """–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"""
        message_lower = message.lower()
        
        password_keywords = ["–ø–∞—Ä–æ–ª—å", "password", "–∑–∞–±—ã–ª", "—Å–±—Ä–æ—Å", "reset", "–≤–æ–π—Ç–∏", "–ª–æ–≥–∏–Ω"]
        access_keywords = ["–¥–æ—Å—Ç—É–ø", "–ø–∞–ø–∫–∞", "—Ñ–∞–π–ª", "–ø—Ä–∞–≤–∞", "—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ", "access", "folder"]
        document_keywords = ["–¥–æ–∫—É–º–µ–Ω—Ç", "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å", "—Ñ–∞–π–ª", "–ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å", "–∑–∞–≥—Ä—É–∑–∏—Ç—å", "document"]
        connection_keywords = ["–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ", "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç", "—Å–µ—Ç—å", "vpn", "wi-fi", "wifi", "connection"]
        software_keywords = ["–ø—Ä–æ–≥—Ä–∞–º–º–∞", "—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å", "–æ–±–Ω–æ–≤–∏—Ç—å", "—Å–æ—Ñ—Ç", "–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", "software"]
        
        if any(keyword in message_lower for keyword in password_keywords):
            return "password"
        elif any(keyword in message_lower for keyword in access_keywords):
            return "access"
        elif any(keyword in message_lower for keyword in document_keywords):
            return "documents"
        elif any(keyword in message_lower for keyword in connection_keywords):
            return "connection"
        elif any(keyword in message_lower for keyword in software_keywords):
            return "software"
        else:
            return "general"
    
    def _get_fallback_response(self, message: str) -> str:
        """–†–µ–∑–µ—Ä–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"""
        category = self.classify_message(message)
        
        if category in self.knowledge_base:
            return f"–í–æ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É:\n\n{self.knowledge_base[category]}"
        
        return """
–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —è –Ω–µ –º–æ–≥—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å. 
–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –ò–¢-–ø–æ–¥–¥–µ—Ä–∂–∫–∏:

üìß Email: it-support@company.com
üìû –¢–µ–ª–µ—Ñ–æ–Ω: +7 (495) 123-45-67
üïê –†–∞–±–æ—á–∏–µ —á–∞—Å—ã: –ü–Ω-–ü—Ç 9:00-18:00

–ò–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –≤ ServiceDesk —Å–∏—Å—Ç–µ–º–µ.
        """
